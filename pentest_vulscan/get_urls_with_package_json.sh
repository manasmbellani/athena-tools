#!/bin/bash
# 
# Script to get the list of URLs that have a package.json file exposed which 
# tends to reveals sensitive info about the dependencies in use on the website
# 
# Based on: 
#     https://docs.npmjs.com/files/package.json
#     https://github.com/sindresorhus/package-json/blob/master/package.json
#   
if [ $# -lt 1 ]; then
    echo "[-] ...<urls>... | $0 run"
    exit 1
fi

urls=$(cat -)

# Get the current script directory that we are working in
script_dir=$(dirname $0)

# Loop through each URL
IFS=$'\n'
for url in $urls; do
    if [ ! -z "$url" ]; then
        
        # Get the URL upto the directory path
        url_dir=$(echo "$url" | "$script_dir"/get_url_parts.sh "url_dir")

        # Regex to use to identify vulnerable sites
        regex="HTTP/1.1 20.*(description|dependencies|\
devDependencies|keywords|contributors|peerDependencies|engineStrict|\
publishConfig)"

        # Run the tests on the various file paths
        url_to_test="$url_dir/package.json"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex"

        url_to_test="$url_dir/npm-package.json"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex"

    fi
done
