#!/bin/bash
# 
# Script runs an NMAP scan and then runs searchsploit on the target to display 
# any vulnerabilities
# 
# The methods available for this:
#      searchsploit - Runs nmap scan on the target, and then invokes
#          searchsploit on the XML output to show potential vulnerabilitiese
#      findsploit - Runs findsploit to search for exploits based on the 
#          technology in use.
# 

if [ $# -lt 1 ]; then
    echo "[-] cat ...<target|port|proto>... | $0 run [method=searchsploit|findsploit] \
[technology_name_version='...<technology name + version e.g. apache 2.2.9>...'] \
[searchsploit_ports=common|all|...<ports e.g. 80,443>...]"
    exit 1
fi
method=${2:-"searchsploit"}
technology_name_version=${3:-""}
searchsploit_ports=${4:-"common"}

# Get list of target/port/protocol from user
combos=$(cat -)

# Script directory
script_dir=$(dirname "$0")

# Determine the nmap ports to use for scanning
if [ "$searchsploit_ports" == "common" ]; then
    nmap_ports_arg="--top-ports 1000"
elif [ "$searchsploit_ports" == "all" ]; then
    nmap_ports_arg="-p -"
else
    nmap_ports_arg="-p $searchsploit_ports"
fi


# Loop through each combination and identify all SSH hosts
IFS=$'\n'
for combo in $combos; do
    if [ ! -z "$combo" ]; then

        # Get the target from combination of target|protocol|port
        target=$(echo "$combos" | $script_dir/get_target_combo_parts.sh 'target') 

        # Prepare the output file
        outfile_xml="out-nmap-target-$target.xml"
        outfile_txt="out-nmap-target-$target.txt"

        if [ "$method" == "searchsploit" ]; then
            echo "[*] Invoking nmap + searchsploit scan on target: $target for \
nmap ports: $seSarchsploit_ports"

            echo "$combo" | \
                $script_dir/invoke_cmd_on_target.sh "nmap -Pn -sS -sV \
$nmap_ports_arg -oN $outfile_txt -oX $outfile_xml TARGET; searchsploit --xml \
$outfile_xml"
        elif [ "$method" == "findsploit" ]; then
            if [ ! -z "$technology_name_version" ]; then
                echo "[*] Invoking findsploit to search for exploit for 
technology: $technology_name_version"
                /opt/Findsploit/findsploit "$technology_name_version"
            fi
        else
            echo "[-] Unknown method: $method specified."
            exit 1
        fi
    fi
done