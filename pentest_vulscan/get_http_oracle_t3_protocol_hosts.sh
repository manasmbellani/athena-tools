#!/bin/bash
# 
# Description: 
#     Determine the list of targets that have Oracle T3 running
# 
# Typical Usage: 
#     "[-] cat ...<targets>... | ./get_http_oracle_t3_protocol_hosts.sh \
#         [method=nmap]
# 
# Output: 
#     target|port found that have been running Oracle T3 protocol
# 
# Args:
#     method: Method to use for determining if T3 Oracle protocol in-use. Can 
#         be one of:
#             nmap: nmap

DELIM="|"
ORACLE_T3_PORTS="7001-7010"

if [ $# -lt 1 ]; then
    echo "[-] cat ...<targets>... | ./get_http_oracle_t3_protocol_hosts.sh \
[method=nmap|jndiat]"
    exit 1
fi
method="$1"

targets=$(cat -)

IFS=$'\n'
for target in $targets; do

    if [ ! -z "$target" ]; then

        if [ "$method" == "nmap" ]; then
            # Temporary file
            tcp_tmpfile="$(mktemp -u)"
            
            # Regex to check if the output
            regex="/tcp\s*open"

            # Run the nmap scan
            /bin/bash -c "sudo nmap --open -sS -p "$ORACLE_T3_PORTS" -Pn $target \
    > $tcp_tmpfile"

            # Check regex
            ports_found=$(cat "$tcp_tmpfile" \
                | egrep -i "$regex" \
                | cut -d"/" -f1)
            
            # Display the ports that are found to be live
            IFS=$'\n'
            for port in $ports_found; do
                echo "$target$DELIM$port"
            done

            # Clear the output file
            rm "$tcp_tmpfile"
        else
            echo "[-] Unknown method: $method"
        fi
    fi
done