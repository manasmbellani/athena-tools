#!/bin/bash
# 
# Script uses the output of get_target_running_ports_services.sh to locate 
# targets/ports which are running the specified protocol. 
# 
# 
# 
# Input: 
#     Output of ./get_running_ports_services.sh to locate targets that are 
#     running specific ports, services
# 
# Args:
#     protocol: Protocol to check for. Currently, the following are supported:
#         oracle_t3
#         http
#         https
#         dns
#         tftp
#         smtp
#         rpc
#         ms-wbt
#         rdpgateway
#         ssh
#         ftp
#         minishare
#         smb
# 
if [ $# -lt 1 ]; then
    echo "[-] ...<target/ports/services>... | $0 <protocol>"
    exit 1
fi
protocol="$1"

# Delimiter
DELIM="|"

# Listen for the targets/ports/protocols output
targets_ports_protocol_out=$(cat -)

# Determine the regex for given protocol
protocol_regex=""
if [ "$protocol" == "oracle_t3" ]; then
    protocol_regex="(700[0-9]|7010).*tcp"
elif [ "$protocol" == "http" ]; then
    protocol_regex="http[^s]"
elif [ "$protocol" == "https" ]; then
    protocol_regex="(http/ssl|ssl/ssl|ssl/http|https|ssl/)"
elif [ "$protocol" == "dns" ]; then
    protocol_regex="dns|\\"$DELIM"domain)"
elif [ "$protocol" == "tftp" ]; then
    protocol_regex="tftp"
elif [ "$protocol" == "smtp" ]; then
    protocol_regex="smtp"
elif [ "$protocol" == "rpc" ]; then
    protocol_regex="rpcbind|portmap"
elif [ "$protocol" == "ms-wbt" ]; then
    protocol_regex="rpcbind|portmap"
elif [ "$protocol" == "rdpgateway" ]; then
    protocol_regex="(3391|rdp-gateway|rdpgateway)"
elif [ "$protocol" == "ssh" ]; then
    protocol_regex="ssh"
elif [ "$protocol" == "ftp" ]; then
    protocol_regex="[^t]ftp"
elif [ "$protocol" == "minishare" ]; then
    protocol_regex="^123^[0-9]"
elif [ "$protocol" == "smb" ]; then
    protocol_regex="microsoft-ds|netbios|smb|samba|smbd"
else
    # Unknown protocol - no regex found
    echo "[-] Unknown regex: $protocol" 1>&2
fi

# Write out the protocols that meet the specified criteeria
if [ ! -z "$protocol_regex" ]; then
    echo "$targets_ports_protocol_out" | grep -iE "$protocol_regex"
fi

