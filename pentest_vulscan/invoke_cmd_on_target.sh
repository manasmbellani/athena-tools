#!/bin/bash
#
# Invoke a command on target/port combination using the target/port/protocol 
# placeholder, defined as TARGET/PORT/PROTOCOL
# 
# 
DELIM="|"

if [ $# -lt 1 ]; then
    echo "[-] cat ...<target/port/service>... | ./invoke_cmd_on_target <cmd> \
        [get_output_as_oneline=0]"
    exit 1
fi
cmd="$1"
get_output_as_oneline=${2:-"0"}

lines=$(cat -)

IFS=$'\n'
for line in $lines; do

    if [ ! -z "$line" ]; then
        target=$(echo "$line" | cut -d"$DELIM" -f1)
        port=$(echo "$line" | cut -d"$DELIM" -f2)
        protocol=$(echo "$line" | cut -d"$DELIM" -f3)

        cmd_to_exec=$(echo "$cmd" \
            | sed -E "s/TARGET/$target/g" \
            | sed -E "s/PORT/$port/g" \
            | sed -E "s/PROTOCOL/$protocol/g")

        cmd_out=$(/bin/bash -c "$cmd_to_exec")        

        if [ "$get_output_as_oneline" == "1" ]; then
            (echo "$target$DELIM$port$DELIM$protocol$DELIM"; \
             echo "$cmd_out") \
            | tr -s "\r\n" "$DELIM"
        else
            (echo "$target$DELIM$port$DELIM$protocol$DELIM"; \
             echo "$cmd_out")
        fi
    fi
done