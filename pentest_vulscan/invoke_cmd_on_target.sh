#!/bin/bash
#
# Invoke a command and check if it matches the given filter criteria.
# If no regex specified, then the command is just output as-is
# 

DELIM="|"

if [ $# -lt 1 ]; then
    echo "[-] ...<cmd>... | $0 run [regex_filter]"
    exit 1
fi
regex_filter="$2"

# Read input lines
lines=$(cat -)

IFS=$'\n'
for line in $lines; do

    if [ ! -z "$line" ]; then
        #target=$(echo "$line" | cut -d"$DELIM" -f1)
        #port=$(echo "$line" | cut -d"$DELIM" -f2)
        #protocol=$(echo "$line" | cut -d"$DELIM" -f3)

        # Each command is the input line
        cmd="$line"

        # Make the web request
        cmd_out=$(/bin/bash -c "$cmd")

        # Put the entire request into a single line
        cmd_out_one_line=$(echo "$cmd_out" | tr -s "\r\n" "$DELIM")

        if [ ! -z "$regex_filter" ]; then

            # Check if it matches filter - if it does, print the URL out
            resp_matches=$(echo "$cmd_out_one_line" \
                | grep -iE "$regex_filter")
            
            # If response matching regex, then print command run
            if [ ! -z "$resp_matches" ]; then
                echo "$cmd"
            fi
        else
            # Writing output for the given command
            echo "$cmd_out"
        fi
    fi
done