#!/bin/bash
# 
# Script to get the list of URLs that could have exposed swagger file
# 
if [ $# -lt 1 ]; then
    echo "[-] ...<urls>... | $0 run"
    exit 1
fi

urls=$(cat -)

# Get the current script directory that we are working in
script_dir=$(dirname $0)

# Loop through each URL
IFS=$'\n'
for url in $urls; do
    if [ ! -z "$url" ]; then
        
        # Get the URL upto the directory path
        url_dir=$(echo "$url" | "$script_dir"/get_url_parts.sh "url_dir")

        # Regex to use to identify Swagger UI portal
        regex_swagger_ui="HTTP/1.1 20.*(Swagger UI|List Operations|Expand Operations\
|API Version|Base URL|Request Information|URI Parameters|Body Parameters\
|Response Formats)"

        # Regex to use to identify Swagger JSON
        regex_swagger_json="HTTP/1.1 20.*(application/json|text/json).*\
(version|summary|parameters|description|required)"

        url_to_test="$url_dir/api/swagger.html"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/api/v1/api-docs"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/swagger-ui.html"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/swagger/swagger-ui.html"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"
        
        url_to_test="$url_dir/v1.x/swagger-ui.html"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/swagger/"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/swagger/index.html"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/api/v1/token"
        echo "$url_to_test" | "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_ui"

        url_to_test="$url_dir/api/v1/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"

        url_to_test="$url_dir/api/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"
        
        url_to_test="$url_dir/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"

        url_to_test="$url_dir/swagger/v1/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"

        url_to_test="$url_dir/swagger/v2/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"

        url_to_test="$url_dir/swagger/v3/swagger.json"
        echo "$url_to_test" |  "$script_dir"/invoke_web_request_on_target.sh run \
        "$regex_swagger_json"

    fi
done
