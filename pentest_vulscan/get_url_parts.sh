#!/bin/bash
#
# Script can extract various parts of a URL e.g. protocol, domain, port, path
# based on the user inputs, and the request.
#
# Inputs: 
#     URLs, one or more from the user input. These can be of the form: 
#         [protocol]://[target]:[port]/[path]?[query_string]
# 
# Args:
#   spec: Defines what to extract from each URL provided. E.g.
#         'proto/protocol'
#         'target', aka IP/Domain to scan
#         'port': Port that was requested
#         'dir_path'/'dir': Directory from the path that was requested
#         'path': URL path that was requested
#         'path_querystr'
#         'target_port'
#         'target_port_path'
#         'protocol_target_port_dir'/'url_dir'
#         'url_wo_querystr'/'protocol_target_port_path'
#         'all': combines ALL parts extracted to formulate the URL again
# 
# Examples:
#     To get the URL without query string from "https://www.google.com:443/test.txt?s=1&d=2"
#         echo "https://www.google.com:443/test.txt?s=1&d=2" | \
#             ./extract_url_parts.sh url_wo_querystr
if [ $# -lt 1 ]; then
    echo " ...<urls>... | ./extract_url_parts.sh <spec>"
    exit 1
fi
spec="$1"

# Get all the URLs
urls=$(cat -)

IFS=$'\n'
for url in $urls; do
    protocol=""
    target=""
    port=""
    path=""
    querystr=""

    # Get the protocol
    contains_protocol=$(echo "$url" | grep -i "://")
    if [ ! -z "$contains_protocol" ]; then
        protocol=$(echo "$url" | cut -d ":" -f1)
        url_wo_protocol=$(echo "$url" | cut -d "/" -f3-)
    else
        url_wo_protocol="$url"
    fi

    
    # Check if target/port present OR only target specified
    contains_target_port=$(echo "$url_wo_protocol" | grep -vEi "^/")
    if [ ! -z "$contains_target_port" ]; then
        # Get the target and port
        target_port=$(echo "$url_wo_protocol" | cut -d"?" -f1 | cut -d "/" -f1)

        # Check if port is present next to target - typically with :
        contains_port=$(echo "$target_port" | grep -i ":")
        if [ ! -z "$contains_port" ]; then
            # Get the port and target
            target=$(echo "$target_port" | cut -d":" -f1)
            port=$(echo "$target_port" | cut -d":" -f2)
        else
            # Only target must be specified, no port in url
            target="$target_port"
            port=""
        fi
        
        # Check if path is present in URL
        contains_path=$(echo "$url_wo_protocol" | grep -Ei "/")
        if [ ! -z "$contains_path" ]; then
            url_wo_target_port_proto=$(echo "$url_wo_protocol" | cut -d "/" -f2-)
        else
            # Check if query string specified
            contains_qstr=$(echo "$url_wo_protocol" | grep "?")
            if [ ! -z "$contains_qstr" ]; then
                url_wo_target_port_proto=$(echo "$url_wo_protocol" | cut -d"?" -f2)
            else
                url_wo_target_port_proto=""
            fi
        fi
    else 
        target_port=""
        url_wo_target_port_proto=$(echo "$url_wo_protocol")
    fi
    

    # Check if query string specified
    contains_qstr=$(echo "$url_wo_target_port_proto" | grep "?")
    if [ ! -z "$contains_qstr" ]; then
        # Get the url path and query string
        path=$(echo "$url_wo_target_port_proto" | cut -d"?" -f1)
        querystr=$(echo "$url_wo_target_port_proto" | cut -d"?" -f2)
    else
        # No query string - whatever left must be path
        path="$url_wo_target_port_proto"
        querystr=""
    fi

    # Get directory from the path correctly - sometimes dirname will return
    # / if /test/ provided so check that path ends correctly
    path_ends_with_slash=$(echo "$path" | grep -IE "/$")
    path_contains_slash=$(echo "$path" | grep -iE "/")
    if [ ! -z "$path" ]; then
        if [ ! -z "$path_contains_slash" ]; then
            if [ ! -z "$path_ends_with_slash" ]; then
                dir_path=$(echo "$path" | sed -E "s|\/$||g")
            else
                dir_path=$(dirname "$path" )
            fi
        else
            # If path doesn't have slash (/)
            dir_path=""
        fi
    else
        dir_path=""
    fi 

    # For debugging
    #echo "$url: $protocol, $target, $port, $path, $querystr"

    if [ "$spec" == "protocol" ]; then
        echo "$protocol"
    elif [ "$spec" == "target" ]; then
        echo "$target"
    elif [ "$spec" == "port" ]; then
        echo "$port"
    elif [ "$spec" == "path" ]; then
        echo "$path"
    elif [ "$spec" == "querystr" ]; then
        echo "$querystr"
    elif [ "$spec" == "dir" ] || [ "$spec" == "dir_path" ]; then
        echo "$dir_path"
    elif [ "$spec" == "path_querystr" ]; then
        if [ ! -z "$querystr" ]; then
            echo "$path?$querystr"
        else
            echo "$path"
        fi
    elif [ "$spec" == "target_port" ]; then
        if [ ! -z "$port" ]; then
            echo "$target:$port"
        else
            echo "$target"
        fi
    elif [ "$spec" == "target_port_path" ]; then
        if [ ! -z "$path" ]; then
            if [ ! -z "$port" ]; then
                echo "$target:$port/$path"
            else
                echo "$target/$path"
            fi
        else
            if [ ! -z "$port" ]; then
                echo "$target:$port"
            else
                echo "$target"
            fi
        fi
    elif [ "$spec" == "target_port_dir" ]; then
        if [ ! -z "$path" ]; then
            if [ ! -z "$port" ]; then
                echo "$target:$port/$dir_path"
            else
                echo "$target/$dir_path"
            fi
        else
            if [ ! -z "$port" ]; then
                echo "$target:$port"
            else
                echo "$target"
            fi
        fi
    elif [ "$spec" == "protocol_target_port_dir" ] || \
        [ "$spec" == "url_dir" ]; then
        if [ ! -z "$protocol" ]; then
            if [ ! -z "$dir_path" ]; then
                if [ ! -z "$port"]; then
                    echo "$protocol://$target:$port/$dir_path"
                else
                    echo "$protocol://$target/$dir_path"
                fi
            else
                if [ ! -z "$port"]; then
                    echo "$protocol://$target:$port"
                else
                    echo "$protocol://$target"
                fi
            fi
        else
            if [ ! -z "$dir_path" ]; then
                if [ ! -z "$port"]; then
                    echo "$target:$port/$dir_path"
                else
                    echo "$target/$dir_path"
                fi
            else
                if [ ! -z "$port"]; then
                    echo "$target:$port"
                else
                    echo "$target"
                fi
            fi
        fi
    elif [ "$spec" == "url_wo_querystr" ] || \
        [ "$spec" == "protocol_target_port_path" ]; then
        if [ ! -z "$protocol" ]; then
            if [ ! -z "$path" ]; then
                if [ ! -z "$port"]; then
                    echo "$protocol://$target:$port/$path"
                else
                    echo "$protocol://$target/$path"
                fi
            else
                if [ ! -z "$port"]; then
                    echo "$protocol://$target:$port"
                else
                    echo "$protocol://$target"
                fi
            fi
        else
            if [ ! -z "$path" ]; then
                if [ ! -z "$port"]; then
                    echo "$target:$port/$path"
                else
                    echo "$target/$path"
                fi
            else
                if [ ! -z "$port"]; then
                    echo "$target:$port"
                else
                    echo "$target"
                fi
            fi
        fi
    elif [ "$spec" == "all" ]; then
        if [ ! -z "$querystr" ]; then
            echo "$protocol://$target:$port/$path?$querystr"
        else
            echo "$protocol://$target:$port/$path"
        fi
    fi
done
