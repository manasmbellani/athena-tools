#!/bin/bash
#
# Script will create Covenant C2 container and also install all necessary deps. 
# If Covenant docker container is already running, it will be restarted
# 
# Args:
#     clear-covenant-db: Clear the covenant database if set to 1"
#     recreate-container: Recreate Covenant container, if set to 1"
#     reinstall-covenant: Reinstall covenant, by re-cloning repo and rebuilding image, if set to 1"
# 
if [ $# -lt 1 ]; then
    echo "[-] $0 run [clear-covenant-db=0] [recreate-container=0] \
[reinstall-covenant=0]"
    exit 1
fi
clear_covenant_db=${2:-"0"}
recreate_container=${3:-"0"}
reinstall_covenant=${4:-"0"}

if [ ! -d "/opt/Covenant" ] || [ "$reinstall_covenant" == "1" ]; then
    echo "[*] Cloning Covenant in the /opt/ directory..."
    git clone --recurse-submodules https://github.com/cobbr/Covenant /opt/Covenant

    echo "[*] Getting the latest updates into Covenant directory..."
    cd /opt/Covenant
    git pull
fi


echo "[*] Checking if the Covenant image exists"
does_covenant_image_exist=`docker images | grep -i covenant`
if [ -z "$does_covenant_image_exist" ]; then

    echo "[+] Covenant image needs to be created"
    create_covenant_image=1
fi

if [ "$clear_covenant_db" == "1" ]; then
    if [ -f "/opt/Covenant/Covenant/Data/covenant.db" ]; then
        echo "[*] Clearing covenant database for delete all data..."
        rm /opt/Covenant/Covenant/Data/covenant.db
    else
        echo "[*] Covenant database does not exist"
    fi
fi


if [ "$create_covenant_image" == "1" ] || [ "$reinstall_covenant" == "1" ]; then

    echo "[*] Switching to the Covenant folder..."
    cd /opt/Covenant/Covenant

    echo "[*] Removing any existing docker images with 'covenant' name..."
    docker images | grep -i covenant | tr -s "  " " " | cut -d" " -f3 | xargs -I [] docker rmi []

    echo "[*] Building the image..."
    docker build -t covenant .

fi

echo "[*] Checking if container exists"
does_covenant_container_exist=`docker container ls -a | grep -i covenant`

if [ "$recreate_container" == "1" ] || \
    [ "$create_covenant_image" == "1" ] || \
    [ "$reinstall_covenant" == "1" ] || \
    [ -z "$does_covenant_container_exist" ]; then

    echo "[*] Removing any existing container with specified 'covenant' name..."
    docker container ls -a | grep -i covenant | cut -d" " -f1 | xargs -I [] docker rm []

    echo "[*] Setting up the docker container"
    docker run -it -p 7443:7443 -p 8081:8081 -p 8082:8082 -p 8083:8083 -p 80:80 -p 443:443 --name covenant -v /opt/Covenant/Covenant/Data:/app/Data covenant

else
    echo "[*] Restarting the docker container..."
    docker stop covenant
    docker start covenant -a -i
fi


